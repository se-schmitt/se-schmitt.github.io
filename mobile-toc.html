<script>
document.addEventListener("DOMContentLoaded", function() {
  const toc = document.getElementById("TOC");
  if (toc) {
    // Create the header container
    const header = document.createElement("div");
    header.className = "toc-header";
    
    // Create Back button
    const backBtn = document.createElement("span");
    backBtn.className = "toc-back";
    backBtn.innerHTML = 'Close <i class="bi bi-x-lg"></i>';
    backBtn.onclick = function(e) {
      e.stopPropagation(); 
      toc.classList.remove("expanded");
    };
    
    // Create Theme Toggle
    const toggleBtn = document.createElement("a");
    toggleBtn.className = "toc-theme-toggle";
    toggleBtn.href = "javascript:void(0)";
    toggleBtn.onclick = function(e) {
      e.stopPropagation();
      if (window.quartoToggleColorScheme) {
        window.quartoToggleColorScheme();
      }
    };
    // Add icons
    toggleBtn.innerHTML = '<i class="bi bi-moon-fill"></i><i class="bi bi-sun-fill"></i>';
    
    header.appendChild(toggleBtn);
    header.appendChild(backBtn);
    
    // Insert header at the top of TOC
    toc.insertBefore(header, toc.firstChild);

    // Add click event to TOC to expand
    toc.addEventListener("click", function(e) {
      if (!this.classList.contains("expanded")) {
        this.classList.add("expanded");
      }
    });
    
    // Close when clicking a link
    const links = toc.querySelectorAll("a");
    links.forEach(link => {
      link.addEventListener("click", function(e) {
         // Don't close if clicking the toggle
         if (link.classList.contains("toc-theme-toggle") || link.closest(".toc-theme-toggle")) {
             return;
         }
         toc.classList.remove("expanded");
      });
    });
  }
});
</script>
